name: Deploy to local server

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Image tag (commit SHA)
        required: true
        default: latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH & deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}         # –Ω–∞–ø—Ä–∏–º–µ—Ä, host.docker.internal
          username: ${{ secrets.DEPLOY_USER }}     # –Ω–∞–ø—Ä–∏–º–µ—Ä, aryurkov
          key: ${{ secrets.DEPLOY_KEY }}           # –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á, –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
          port: 22
          script: |
            echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ, –≤—ã–ø–æ–ª–Ω—è—é –¥–µ–ø–ª–æ–π..."
            cd ~/Documents/bank-bi-superset
            export IMAGE_TAG="${{ github.event.inputs.tag }}"
            docker login ghcr.io -u ${{ secrets.GHCR_USER }} -p ${{ secrets.GHCR_PAT }}
            docker compose pull superset superset_init
            docker compose up -d
          # üëâ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–∞ —Ö–æ—Å—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å known_hosts –ø—Ä–æ–±–ª–µ–º
          fingerprint: ""
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          debug: true
